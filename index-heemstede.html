<!DOCTYPE html>
<html lang="nl">
  <head>
    <meta charset="utf-8" />
    <title>Bevolking Heemstede</title>
    <script src="https://cdn.jsdelivr.net/npm/vega@5"></script>
    <script src="https://cdn.jsdelivr.net/npm/vega-lite@5"></script>
    <script src="https://cdn.jsdelivr.net/npm/vega-embed@6"></script>
    <style>
      body {
        font-family: sans-serif;
        background: #f9f9f9;
        padding: 2rem;
        margin: 0;
      }
      .container {
        max-width: 1000px;
        margin: auto;
        background: white;
        padding: 2rem;
        border-radius: 12px;
        box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
      }
      .chart {
        margin-bottom: 3rem;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>Bevolking Heemstede</h1>

      <!-- Bevolkingspiramide -->
      <div class="chart">
        <h2>Bevolking naar leeftijd en geslacht</h2>
        <div id="piramide"></div>
      </div>

      <!-- Bevolkingsontwikkeling -->
      <div class="chart">
        <h2>Ontwikkeling totale bevolking en 65+</h2>
        <div id="aandeel"></div>
      </div>
    </div>

    <script type="text/javascript">
      // Bevolkingspiramide
      const piramideSpec = {
        "$schema": "https://vega.github.io/schema/vega-lite/v5.json",
        "width": 700,
        "height": 400,
        "data": {
          "url": "https://raw.githubusercontent.com/Jimvelthuis/cbs-data-heemstede-bloemendaal/main/VegaPyramideHMStab.txt",
          "format": {
            "type": "tsv",
            "parse": {
              "jaar": "number",
              "mannen": "number",
              "vrouwen": "number",
              "leeftijd": "number"
            }
          }
        },
        "transform": [
          { "filter": "datum.jaar == jaar" },
          { "calculate": "datum.mannen * -1", "as": "_mannen" },
          { "calculate": "datum.jaar - datum.leeftijd", "as": "geboortejaar" },
          {
            "calculate": "if(datum.leeftijd > 99, datum.geboortejaar + ' en eerder', datum.geboortejaar)",
            "as": "_geboortejaartooltip"
          },
          {
            "calculate": "if(datum.leeftijd > 99, '+100', datum.leeftijd)",
            "as": "_leeftijdtooltip"
          },
          {
            "fold": ["_mannen", "vrouwen"],
            "as": ["geslacht", "aantal"]
          },
          {
            "calculate": "datum.geslacht == '_mannen' ? 'Mannen' : 'Vrouwen'",
            "as": "GeslachtLabel"
          },
          {
            "calculate": "abs(datum.aantal)",
            "as": "_aantalTooltip"
          }
        ],
        "encoding": {
          "y": {
            "field": "leeftijd",
            "type": "ordinal",
            "sort": "descending",
            "axis": {
              "title": "Leeftijd",
              "labelFontSize": 13,
              "titleFontSize": 15,
              "labelFontWeight": "bold",
              "labelExpr": "datum.value % 10 === 0 ? datum.value : ''"
            }
          },
          "x": {
            "field": "aantal",
            "type": "quantitative",
            "axis": {
              "title": "Aantal personen",
              "labelFontSize": 13,
              "titleFontSize": 15,
              "format": ",d",
              "labelExpr": "abs(datum.value)"
            },
            "scale": { "domain": [-250, 250] }
          },
          "color": {
            "field": "GeslachtLabel",
            "type": "nominal",
            "scale": {
              "domain": ["Mannen", "Vrouwen"],
              "range": ["#a6cee3", "#1f78b4"]
            },
            "legend": {
              "title": "Geslacht",
              "orient": "top",
              "labelFontSize": 14,
              "titleFontSize": 16
            }
          },
          "tooltip": [
            { "field": "_geboortejaartooltip", "title": "Geboortejaar" },
            { "field": "_leeftijdtooltip", "title": "Leeftijd" },
            { "field": "_aantalTooltip", "title": "Aantal" },
            { "field": "GeslachtLabel", "title": "Geslacht" }
          ]
        },
        "mark": { "type": "bar", "tooltip": true },
        "params": [
          {
            "name": "jaar",
            "value": 1988,
            "bind": {
              "input": "range",
              "min": 1988,
              "max": 2024,
              "step": 1
            }
          }
        ]
      };

      // Area Chart met totale bevolking en 65+
      const aandeelSpec = {
        "$schema": "https://vega.github.io/schema/vega-lite/v5.json",
        "width": 700,
        "height": 400,
        "data": {
          "url": "https://raw.githubusercontent.com/Jimvelthuis/cbs-data-heemstede-bloemendaal/main/Bevolking%20HMS%20text.txt",
          "format": { "type": "tsv" }
        },
        "transform": [
          { "filter": "datum['Geslacht'] == 'Totaal mannen en vrouwen'" },
          {
            "calculate": "toNumber(datum['Perioden'])",
            "as": "jaar"
          },
          {
            "calculate": "toNumber(datum['Leeftijd'])",
            "as": "leeftijd"
          },
          {
            "calculate": "toNumber(datum['Bevolking op 1 januari'])",
            "as": "aantal"
          },
          {
            "aggregate": [
              {
                "op": "sum",
                "field": "aantal",
                "as": "totaal"
              }
            ],
            "groupby": ["jaar"]
          },
          {
            "lookup": "jaar",
            "from": {
              "data": {
                "url": "https://raw.githubusercontent.com/Jimvelthuis/cbs-data-heemstede-bloemendaal/main/Bevolking%20HMS%20text.txt",
                "format": { "type": "tsv" }
              },
              "key": "Perioden",
              "fields": ["Leeftijd", "Geslacht", "Bevolking op 1 januari"],
              "as": ["leeftijd2", "geslacht2", "aantal2"]
            }
          },
          {
            "filter": "datum.geslacht2 == 'Totaal mannen en vrouwen' && datum.leeftijd2 >= 65"
          },
          {
            "calculate": "toNumber(datum.aantal2)",
            "as": "aantal_65plus"
          },
          {
            "aggregate": [
              { "op": "sum", "field": "aantal_65plus", "as": "totaal_65plus" }
            ],
            "groupby": ["jaar", "totaal"]
          },
          {
            "fold": ["totaal", "totaal_65plus"],
            "as": ["categorie", "waarde"]
          },
          {
            "calculate": "datum.categorie == 'totaal' ? 'Totale bevolking' : 'Bevolking 65+'",
            "as": "categorie_label"
          }
        ],
        "mark": {
          "type": "area",
          "interpolate": "monotone",
          "opacity": 0.6
        },
        "encoding": {
          "x": {
            "field": "jaar",
            "type": "temporal",
            "axis": {
              "title": "Jaar",
              "labelFontSize": 13,
              "titleFontSize": 15
            }
          },
          "y": {
            "field": "waarde",
            "type": "quantitative",
            "axis": {
              "title": "Aantal personen",
              "labelFontSize": 13,
              "titleFontSize": 15
            }
          },
          "color": {
            "field": "categorie_label",
            "type": "nominal",
            "scale": {
              "domain": ["Totale bevolking", "Bevolking 65+"],
              "range": ["#a6cee3", "#1f78b4"]
            },
            "legend": {
              "title": "Bevolkingsgroep",
              "orient": "top",
              "labelFontSize": 14,
              "titleFontSize": 16
            }
          },
          "tooltip": [
            { "field": "jaar", "title": "Jaar", "type": "temporal" },
            { "field": "waarde", "title": "Aantal" },
            { "field": "categorie_label", "title": "Groep" }
          ]
        }
      };

      vegaEmbed("#piramide", piramideSpec, { actions: false });
      vegaEmbed("#aandeel", aandeelSpec, { actions: false });
    </script>
  </body>
</html>
